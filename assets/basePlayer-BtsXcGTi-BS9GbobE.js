import{g,l as o,z as d,C as n,r as i,y as m,u as P,F as h,N as I,L as S,q as y,V as T,j as v,G as f,s as c,x as b,o as k}from"./index-BN722jHt-DTA5ozQl.js";function _(r,e){return new CustomEvent("media-product-transition",{detail:{mediaProduct:r,playbackContext:e}})}const R=({assetPosition:r,duration:e,playbackInfo:t,streamInfo:a})=>({actualAssetPresentation:t.assetPresentation,actualAudioMode:"audioMode"in t?t.audioMode:null,actualAudioQuality:"audioQuality"in t?t.audioQuality:null,actualDuration:e,actualProductId:String("videoId"in t?t.videoId:t.trackId),actualStreamType:"streamType"in t?t.streamType:null,actualVideoQuality:"videoQuality"in t?t.videoQuality:null,assetPosition:r,bandwidth:null,bitDepth:a.bitDepth??null,codec:a.codec??null,playbackSessionId:a.streamingSessionId,sampleRate:a.sampleRate??null});function A(r,e){return new CustomEvent("ended",{detail:{mediaProduct:e,reason:r}})}function L(r){return new CustomEvent("playback-state-change",{detail:{state:r}})}function E(){return new CustomEvent("preload-request")}function p(r){return Math.min(Math.pow(10,(4+r)/20),1/1)}function M(r){switch(r){case"completed":return"COMPLETE";case"error":return"ERROR";default:return"OTHER"}}class x{#e;#s;#t;#i=void 0;#r;#a="IDLE";#n;#o;name;constructor(){g.addEventListener("desiredVolumeLevel",()=>{this.isActivePlayer&&this.updateVolumeLevel()})}#d(){this.duration&&Math.abs(this.#s-this.duration)<=30&&this.#i===!1&&(this.#i=!0,o.dispatchEvent(E()))}#c({endAssetPosition:e,endReason:t,streamingSessionId:a}){this.debugLog("mediaProductEnded"),d.preloadedStreamingSessionId&&performance.mark("streaming_metrics:playback_statistics:idealStartTimestamp",{detail:d.preloadedStreamingSessionId,startTime:n.now()});const s=i.getMediaProductTransition(a);s&&o.dispatchEvent(A(t,s.mediaProduct)),this.eventTrackingStreamingEnded(a,{endAssetPosition:e,endReason:t}),i.deleteSession(a),this.currentStreamingSessionId===a&&(this.currentStreamingSessionId=void 0),this.updateVolumeLevelForNextProduct()}adjustedVolume(e){const t=m("desiredVolumeLevel"),a=m("loudnessNormalizationMode");let s=t;return a==="ALBUM"&&e.albumReplayGain&&(s*=p(e.albumReplayGain)),a==="TRACK"&&e.trackReplayGain&&(s*=p(e.trackReplayGain)),this.debugLog("adjustedVolume",`Volume adjusted from ${t} to ${s}`),parseFloat(s.toFixed(2))}attachPlaybackEngineEndedHandler(){this.#t||(this.#t=this.playbackEngineEndedHandler.bind(this),o.addEventListener("ended",this.#t))}cleanUpStoredPreloadInfo(){this.preloadedStreamingSessionId&&this.preloadedStreamingSessionId!==this.currentStreamingSessionId&&(i.deleteSession(this.preloadedStreamingSessionId),this.preloadedStreamingSessionId=void 0)}debugLog(...e){document.location.href.includes("localhost")&&document.location.hash.includes("debug")&&console.debug(`[%cPlayerSDK${this.name?`%c${d.activePlayer?.name===this.name?"⚯":"⚮"}%c`+this.name:""}${this.#e?"%c::%c"+this.#e?.split("-").pop():""}%c]`,"color:#00d6ff",...this.name?["color:inherit","color:#b7fa34"]:[],...this.#e?["color:inherit","color:#d947ff"]:[],"color:inherit",...e)}detachPlaybackEngineEndedHandler(){this.#t&&(o.removeEventListener("ended",this.#t),this.#t=void 0)}eventTrackingStreamingEnded(e,{endAssetPosition:t,endReason:a}){const s=n.now();P([h({endAssetPosition:t,endTimestamp:s,streamingSessionId:e})]).catch(console.error),I([S({endReason:M(a),endTimestamp:s,streamingSessionId:e}),y({streamingSessionId:e,timestamp:s})]).catch(console.error)}eventTrackingStreamingStarted(e){if(!e)return;performance.mark("streaming_metrics:playback_statistics:actualStartTimestamp",{detail:e,startTime:n.now()}),performance.measure("idealStartTimestamp -> actualStartTimestamp",{detail:e,end:"streaming_metrics:playback_statistics:actualStartTimestamp",start:"streaming_metrics:playback_statistics:idealStartTimestamp"});try{S({actualStartTimestamp:n.timestamp("streaming_metrics:playback_statistics:actualStartTimestamp",e),idealStartTimestamp:n.timestamp("streaming_metrics:playback_statistics:idealStartTimestamp",e),outputDevice:this.#r,streamingSessionId:e})}catch(l){console.error(l,"actualStartTimestamp or idealStartTimestamp is missing for this streaming session")}finally{performance.clearMarks("streaming_metrics:playback_statistics:actualStartTimestamp"),performance.clearMarks("streaming_metrics:playback_statistics:idealStartTimestamp")}const t=i.getMediaProductTransition(e);if(!t){i.hasStartedStreamInfo(e)?console.error(`A media product transition for streaming session #${e} has not been saved and could thus not be found for play log reporting.`):(i.deleteStreamInfo(e),console.warn(`Streaming session #${e} has been discarded due to a new load. This could mean you have a bug in your code where you call load on Player more than once time in a very short time frame.`));return}const{mediaProduct:a,playbackContext:s}=t,u=n.now();h({actualAssetPresentation:s.actualAssetPresentation,actualAudioMode:"actualAudioMode"in s?s.actualAudioMode:null,actualProductId:s.actualProductId,actualQuality:s.actualAudioQuality||s.actualVideoQuality,extras:a.extras,isPostPaywall:v(s.actualAssetPresentation,a),playbackSessionId:e,productType:T(a.productType),requestedProductId:a.productId,sourceId:a.sourceId,sourceType:a.sourceType,startAssetPosition:this.startAssetPosition,startTimestamp:u,streamingSessionId:e}).catch(console.error)}finishCurrentMediaProduct(e){if(!this.hasStarted())return;const t=this.#e,a=t?i.hasStreamInfo(t):!1;this.preloadedStreamingSessionId||(this.playbackState="IDLE"),t&&a&&this.#c({endAssetPosition:this.currentTime,endReason:e,streamingSessionId:t})}getPosition(){return 0}async hardReload(e,t){return this.currentStreamingSessionId&&this.finishCurrentMediaProduct("skip"),f(e,t)}hasNextItem(){return this.preloadedStreamingSessionId}hasStarted(){return this.currentStreamingSessionId&&i.hasStartedStreamInfo(this.currentStreamingSessionId)}load(e,t){return Promise.resolve()}async maybeHardReload(){const e=this.prefetched||this.expired;return this.currentMediaProduct&&e?(await this.hardReload(this.currentMediaProduct,this.currentTime),!0):!1}mediaProductStarted(e){!e||i.hasStartedStreamInfo(e)||(this.debugLog("mediaProductStarted"),this.eventTrackingStreamingStarted(e),i.setStartedStreamInfo(e),this.updateVolumeLevel(),this.#i=!1,this.preloadedStreamingSessionId=void 0,this.unloadPreloadedMediaProduct().catch(console.error),this.attachPlaybackEngineEndedHandler())}next(e){return Promise.resolve()}overwriteMediaProduct(e,t){const a=i.getMediaProductTransition(e);if(a){i.deleteMediaProductTransition(e);const s={mediaProduct:{...a.mediaProduct,...t},playbackContext:{...a.playbackContext}};i.saveMediaProductTransition(e,s)}}pause(){}play(){return Promise.resolve()}playbackEngineEndedHandler(e){return Promise.resolve()}reset(e){return Promise.resolve()}seek(e){}seekEnd(e){const t=this.currentStreamingSessionId;if(t){const a=()=>c(t,{actionType:"PLAYBACK_START",assetPosition:e,timestamp:n.now()});if(this.playbackState==="PLAYING")a().catch(console.error);else{const s=()=>{this.playbackState==="PLAYING"&&(a().catch(console.error),o.removeEventListener("playback-state-change",s))};o.addEventListener("playback-state-change",s)}}}seekStart(e){this.currentStreamingSessionId&&c(this.currentStreamingSessionId,{actionType:"PLAYBACK_STOP",assetPosition:e,timestamp:n.now()}).catch(console.error)}async setStateToXIfNotYInZMs(e,t,a){await b(e),this.playbackState!==t&&(this.playbackState=a)}skipToPreloadedMediaProduct(){return Promise.resolve()}unloadPreloadedMediaProduct(){return Promise.resolve()}updateOutputDevice(){return Promise.resolve()}updateVolumeLevel(){const e=i.getStreamInfo(this.currentStreamingSessionId);e&&(this.volume=this.adjustedVolume(e))}updateVolumeLevelForNextProduct(){const e=i.getStreamInfo(this.preloadedStreamingSessionId);e&&(this.volume=this.adjustedVolume(e))}get currentMediaProduct(){return i.getMediaProductTransition(this.currentStreamingSessionId)?.mediaProduct??null}set currentStreamingSessionId(e){this.#e=e}get currentStreamingSessionId(){return this.#e}set currentTime(e){this.#s=e,this.#d()}get currentTime(){return this.#s}get duration(){const e=i.getMediaProductTransition(this.currentStreamingSessionId);return e?e.playbackContext.actualDuration:null}get expired(){const e=i.getStreamInfo(this.currentStreamingSessionId);return e?e.expires<=Date.now():!1}get isActivePlayer(){return d.activePlayer&&this.name===d.activePlayer.name}get nextItem(){if(this.preloadedStreamingSessionId)return i.getMediaProductTransition(this.preloadedStreamingSessionId)}set outputDeviceType(e){this.#r=e?k(e):void 0}set playbackState(e){const t=this.#a;if(t===e||!this.currentStreamingSessionId)return;const a=(u,l)=>t===u&&l===e;switch(!0){case a("NOT_PLAYING","STALLED"):case a("IDLE","STALLED"):return;case a("PLAYING","NOT_PLAYING"):case a("PLAYING","IDLE"):{this.duration&&this.currentTime<this.duration&&c(this.currentStreamingSessionId,{actionType:"PLAYBACK_STOP",assetPosition:this.currentTime,timestamp:n.now()}).catch(console.error);break}case a("IDLE","PLAYING"):case a("NOT_PLAYING","PLAYING"):{this.currentTime!==this.startAssetPosition&&c(this.currentStreamingSessionId,{actionType:"PLAYBACK_START",assetPosition:this.currentTime,timestamp:n.now()}).catch(console.error);break}}this.#a=e,this.debugLog(`playbackState: ${e}`);const s=d.activePlayer===void 0;(this.isActivePlayer||s)&&o.dispatchEvent(L(this.#a))}get playbackState(){return this.#a}get prefetched(){return i.getStreamInfo(this.currentStreamingSessionId)?.prefetched}set preloadedStreamingSessionId(e){this.#n=e}get preloadedStreamingSessionId(){return this.#n}get startAssetPosition(){return this.#o}set startAssetPosition(e){this.#o=e}get volume(){return 1}set volume(e){}}export{R,_ as w,x};
