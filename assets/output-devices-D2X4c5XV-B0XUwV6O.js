import{l as W,m as O,z as P,K as T,E as q}from"./index-BN722jHt-dG3f1Axa.js";var S,L;function M(){return L||(L=1,S=function(){function a(e,t,n,i,s){return e<t||n<t?e>n?n+1:e+1:i===s?t:t+1}return function(e,t){if(e===t)return 0;if(e.length>t.length){var n=e;e=t,t=n}for(var i=e.length,s=t.length;i>0&&e.charCodeAt(i-1)===t.charCodeAt(s-1);)i--,s--;for(var c=0;c<i&&e.charCodeAt(c)===t.charCodeAt(c);)c++;if(i-=c,s-=c,i===0||s<3)return s;var o=0,r,d,l,h,f,v,m,p,D,I,C,E,u=[];for(r=0;r<i;r++)u.push(r+1),u.push(e.charCodeAt(c+r));for(var A=u.length-1;o<s-3;)for(D=t.charCodeAt(c+(d=o)),I=t.charCodeAt(c+(l=o+1)),C=t.charCodeAt(c+(h=o+2)),E=t.charCodeAt(c+(f=o+3)),v=o+=4,r=0;r<A;r+=2)m=u[r],p=u[r+1],d=a(m,d,l,D,p),l=a(d,l,h,I,p),h=a(l,h,f,C,p),v=a(h,f,v,E,p),u[r]=v,f=h,h=l,l=d,d=m;for(;o<s;)for(D=t.charCodeAt(c+(d=o)),v=++o,r=0;r<A;r+=2)m=u[r],u[r]=v=a(m,d,v,D,u[r+1]),d=m;return v}}()),S}var N=M();const U=q(N);function B(a){return new CustomEvent("device-change",{detail:{devices:a}})}const y=O.parse(navigator.userAgent);class w{controllableVolume;id;name;nativeDeviceId;type;webDeviceId;constructor({controllableVolume:e,name:t,nativeDeviceId:n,type:i,webDeviceId:s}){this.name=t,this.id=n==="default"&&s==="default"?"default":T(),this.nativeDeviceId=n,this.webDeviceId=s,this.type=i,this.controllableVolume=e!==!1}}function b(a){if(k(a))return"windowsCommunication";if("id"in a&&a.id==="BuiltInSpeakerDevice")return"builtIn";if("type"in a&&a.type==="airplay")return"airplay";if("label"in a){const e=a.label.toLowerCase();if(e.includes("bluetooth"))return"bluetooth";if(e.includes("displayport"))return"displayPort";if(e.includes("hdmi"))return"hdmi";if(e.includes("usb"))return"usb";if(e.includes("built-in"))return"builtIn";if(e.includes("airplay"))return"airplay"}}function g(a,e){const t=e.toLowerCase();let n=a;return t.includes("mac")&&(n=(a.split("(")[0]??"").trim()),n}function k(a){let e;return"label"in a&&(e=a.label),"name"in a&&(e=a.name),e?.startsWith("Communications")??!1}function V(a,e){if(e=g(e,y.os.name||""),[...a].length===0||e==="")return;const t=[...a].find(i=>i.name===e);if(t)return t;const n=[...a].filter(i=>e.includes(i.name)||i.name.includes(e)).map(i=>({device:i,distance:U(i.name,e)})).sort((i,s)=>i.distance-s.distance).reverse();if(n.length>0){const i=n.pop();if(i&&i.distance<=16)return i.device}}class z{#i;#a;#n="shared";#e;#t;#s;outputDevices;constructor(){this.#t=new Set,this.#s=new Set,this.#e=new EventTarget,this.#a=new w({name:"System Default",nativeDeviceId:"default",type:"systemDefault",webDeviceId:"default"}),this.#i=this.#a,this.outputDevices=new Set([this.#a]),this.hydrateWebDevices().then().catch(console.error),navigator.mediaDevices.addEventListener("devicechange",()=>{this.hydrateWebDevices().then().catch(console.error)}),this.#e.addEventListener("native-devices",e=>{this.#t=new Set(e.detail),this.queueUpdate().then().catch(console.error)}),this.#e.addEventListener("web-devices",e=>{this.#s=new Set(e.detail),this.queueUpdate().then().catch(console.error)})}addNativeDevices(e){this.#e.dispatchEvent(new CustomEvent("native-devices",{detail:e}))}addWebDevices(e){e=e.filter(t=>t.deviceId!=="default"),this.#e.dispatchEvent(new CustomEvent("web-devices",{detail:e}))}emitDeviceChange(){W.dispatchEvent(B([...this.outputDevices]))}getNativeDevice(e){return[...this.#t].find(t=>t.id===e)}async hydrateWebDevices(){const e=(await navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="audiooutput");this.addWebDevices(e)}mergeDevices(){[...this.outputDevices].filter(e=>e.id!=="default").forEach(e=>{e.nativeDeviceId=void 0,e.webDeviceId=void 0}),this.#t.forEach(e=>{const t=V(this.outputDevices,e.name);t?(t.nativeDeviceId=e.id,t.controllableVolume=e.controllableVolume,t.type=b(e)||t.type):this.outputDevices.add(new w({controllableVolume:e.controllableVolume,name:g(e.name,y.os.name||""),nativeDeviceId:e.id,type:b(e)}))}),this.#s.forEach(e=>{const t=V(this.outputDevices,e.label);t?(t.webDeviceId=e.deviceId,t.type=b(e)||t.type):this.outputDevices.add(new w({name:g(e.label,y.os.name||""),type:b(e),webDeviceId:e.deviceId}))}),[...this.outputDevices].filter(e=>e.webDeviceId===void 0&&e.nativeDeviceId===void 0||e.type==="airplay"||e.type==="windowsCommunication").forEach(e=>this.outputDevices.delete(e))}async queueUpdate(){const e=new Promise(i=>this.#e.addEventListener("native-devices",s=>i(s.detail),{once:!0})),t=new Promise(i=>this.#e.addEventListener("web-devices",s=>i(s.detail),{once:!0})),n=i=>new Promise(s=>setTimeout(()=>s(),i));await Promise.any([e,t,n(1e3)]),this.mergeDevices(),this.emitDeviceChange()}set activeDevice(e){this.#i=e,this.#n="shared",P.activePlayer?.updateOutputDevice()?.catch(console.error)}get activeDevice(){return this.#i}set deviceMode(e){const{activeDevice:t}=this,{activePlayer:n}=P;t&&n&&n.name==="nativePlayer"&&this.deviceMode!==e&&(this.#n=e,n.updateDeviceMode())}get deviceMode(){return this.#n}}const j=new z;export{w as OutputDevice,z as OutputDevices,b as findOutputType,V as getOutputDeviceByName,k as isWindowsCommunicationsDevice,g as marshalLabel,j as outputDevices};
