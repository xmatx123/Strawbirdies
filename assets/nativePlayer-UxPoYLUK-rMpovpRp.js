const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/output-devices-D2X4c5XV-Csd-w9Dk.js","assets/index-BN722jHt-DTA5ozQl.js"])))=>i.map(i=>d[i]);
import{y as v,_ as I,l as s,v as u,L as k,C as p,r as o,z as g,w as S,a as P}from"./index-BN722jHt-DTA5ozQl.js";import{x as E,w as y,R as b}from"./basePlayer-BtsXcGTi-BS9GbobE.js";const f="active-device-disconnected";function w(){return new CustomEvent(f)}const N={file_checksum_mismatch:"NPO02",no_such_file:"NPO01",unreadable_file:"NPO03"},D={devicedisconnected:"NPD01",deviceexclusivemodenotallowed:"NPD02",deviceformatnotsupported:"NPD03",devicelocked:"NPD04",devicenotfound:"NPD05",deviceunknownerror:"NPD00"};let a;class _ extends E{#s="default";#i;#e;#a;name="nativePlayer";playbackEngineHandlerAttached=!1;constructor(){super(),v("outputDevicesEnabled")&&(async()=>(a=(await I(async()=>{const{outputDevices:e}=await import("./output-devices-D2X4c5XV-Csd-w9Dk.js");return{outputDevices:e}},__vite__mapDeps([0,1]))).outputDevices,this.#e.listDevices()))(),this.#e=window.NativePlayerComponent.Player(),this.playbackState="IDLE",this.registerEventListeners(),this.#e.setVolume(100)}#t(e){s.dispatchError(new u("EUnexpected",D[e]))}#r(e){this.debugLog("handleMediaError",e.target);const t=e.target,i=N[t.errorCode];this.currentStreamingSessionId&&k({errorCode:i,errorMessage:JSON.stringify(e.target),streamingSessionId:this.currentStreamingSessionId}),s.dispatchError(new u("EUnexpected",i))}#d(e){switch(this.debugLog("handleNativePlayerStateChange",e),e){case"active":this.playbackState="PLAYING";break;case"idle":case"seeking":this.playbackState="STALLED";break;case"paused":case"ready":this.playbackState="NOT_PLAYING";break;case"stopped":this.playbackState="NOT_PLAYING";break;case"uninitialized":this.playbackState="IDLE";break;default:this.debugLog("No handling for state",e);break}}async#n(){this.debugLog("handleNetworkError");const e=p.timestamp("streaming_metrics:playback_statistics:actualStartTimestamp");if((e!==void 0?Math.abs(p.now()-e):0)>=36e5){const t=structuredClone(this.currentMediaProduct),i=this.currentTime;this.finishCurrentMediaProduct("error"),t&&(await this.hardReload(t,i),await this.play());return}await Promise.race([this.mediaStateChange("idle"),new Promise(t=>{window.addEventListener("online",()=>t("online"))})])==="idle"&&s.dispatchError(new u("PENetwork","NPN01"))}abandon(){a&&a.deviceMode==="exclusive"&&this.#e.selectSystemDevice()}getPosition(){return this.currentTime}async handleAutomaticTransitionToPreloadedMediaProduct(){await this.nativeEvent("mediaduration"),this.#a=void 0;const e=o.getMediaProductTransition(this.preloadedStreamingSessionId);if(!e){console.warn("No media product transition saved for next item. Stopping playback."),this.playbackState="NOT_PLAYING";return}const{mediaProduct:t,playbackContext:i}=e,d={...i,actualDuration:this.#i};this.preloadedStreamingSessionId&&o.saveMediaProductTransition(this.preloadedStreamingSessionId,{mediaProduct:t,playbackContext:d}),await this.mediaStateChange("active"),s.dispatchEvent(y(t,d)),this.currentStreamingSessionId=this.preloadedStreamingSessionId,this.mediaProductStarted(this.currentStreamingSessionId)}async load(e,t){this.debugLog("load",e),this.currentTime=e.assetPosition,this.startAssetPosition=e.assetPosition,await this.reset();const{assetPosition:i,mediaProduct:d,playbackInfo:h,streamInfo:r}=e,{securityToken:c,streamFormat:n,streamUrl:l}=r;this.currentStreamingSessionId=r.streamingSessionId,t==="explicit"&&(this.playbackState="NOT_PLAYING");const L=this.nativeEvent("mediaduration");if(n)this.#e.load(l,n,c);else throw new Error("Stream format is undefined.");if(await L,this.currentStreamingSessionId!==r.streamingSessionId)return;this.debugLog("load() duration is",this.#i),i!==0&&i<this.#i?(async()=>{await this.mediaStateChange("active"),this.currentStreamingSessionId===r.streamingSessionId&&(await this.seek(i),this.currentTime=i)})().catch(console.error):this.currentTime=0;const m=b({assetPosition:i,duration:this.#i,playbackInfo:h,streamInfo:r});o.saveMediaProductTransition(r.streamingSessionId,{mediaProduct:d,playbackContext:m}),this.debugLog("load() mediaProductTransition"),s.dispatchEvent(y(d,m)),this.debugLog("load() pb NOT_PLAYING"),this.debugLog("load() done")}mediaStateChange(e){return new Promise(t=>{this.#e.addEventListener("mediastate",i=>{i.target===e&&t(i.target)})})}nativeEvent(e){return new Promise(t=>{this.#e.addEventListener(e,i=>t(i))})}async next(e){this.debugLog("next",e),this.hasNextItem()&&await this.unloadPreloadedMediaProduct();const{mediaProduct:t,playbackInfo:i,streamInfo:d}=e,{securityToken:h,streamFormat:r,streamUrl:c,streamingSessionId:n}=d;this.preloadedStreamingSessionId=n,this.debugLog("preloading",c,"for",n),r?(this.#e.preload(c,r,h),this.isActivePlayer||this.#e.pause()):console.error("Stream format undefined for preload."),this.debugLog("preloading done");const l=b({assetPosition:0,duration:0,playbackInfo:i,streamInfo:d});o.saveMediaProductTransition(n,{mediaProduct:t,playbackContext:l}),this.#a=e}pause(){this.#e.pause()}async play(){if(this.debugLog("play"),await this.maybeHardReload(),this.playbackState==="IDLE"){this.debugLog("play()",this.playbackState,"returning early");return}this.setStateToXIfNotYInZMs(1e3,"PLAYING","STALLED"),await this.updateOutputDevice(),this.mediaProductStarted(this.currentStreamingSessionId),this.debugLog("nativePlayer","play()"),this.#e.play()}async playbackEngineEndedHandler(e){if(this.isActivePlayer){const{reason:t}=e.detail;t==="completed"&&(this.hasNextItem()?await this.handleAutomaticTransitionToPreloadedMediaProduct():(g.preloadedStreamingSessionId?this.debugLog(`Switching player from ${this.name} to ${g.preloadPlayer?.name}`):this.debugLog("No next item queued."),this.playbackState="NOT_PLAYING"))}}registerEventListeners(){this.debugLog("registerEventListeners"),this.#e.addEventListener("mediacurrenttime",e=>{this.currentTime=Number(e.target)}),this.#e.addEventListener("mediastate",e=>{e.target==="completed"?this.finishCurrentMediaProduct("completed"):this.#d(e.target)}),this.#e.addEventListener("devices",e=>{a?a.addNativeDevices(e.target):console.error("Output devices not loaded.")}),this.#e.addEventListener("devicedisconnected",()=>{s.dispatchEvent(w()),this.#t("devicedisconnected")}),this.#e.addEventListener("deviceexclusivemodenotallowed",()=>this.#t("deviceexclusivemodenotallowed")),this.#e.addEventListener("deviceformatnotsupported",()=>this.#t("deviceformatnotsupported")),this.#e.addEventListener("devicelocked",()=>this.#t("devicelocked")),this.#e.addEventListener("devicenotfound",()=>this.#t("devicenotfound")),this.#e.addEventListener("deviceunknownerror",()=>this.#t("deviceunknownerror")),this.#e.addEventListener("mediaduration",e=>{this.#i=Number(e.target)}),this.#e.addEventListener("mediaerror",e=>this.#r(e)),this.#e.addEventListener("mediamaxconnectionsreached",()=>{this.#n().catch(console.error)})}async reset({keepPreload:e}={keepPreload:!1}){this.currentStreamingSessionId!==void 0&&(this.debugLog("reset"),e||await this.unloadPreloadedMediaProduct(),this.#e.stop(),this.playbackState!=="IDLE"&&this.finishCurrentMediaProduct("skip"),this.detachPlaybackEngineEndedHandler(),this.currentStreamingSessionId=void 0,e||(this.preloadedStreamingSessionId=void 0),this.playbackState="IDLE")}async seek(e){this.hasStarted()||await this.mediaStateChange("active"),this.seekStart(this.currentTime),this.currentTime=e,this.#e.seek(e),this.seekEnd(this.currentTime)}async skipToPreloadedMediaProduct(){this.debugLog("skipToPreloadedMediaProduct",this.preloadedStreamingSessionId);const e=this.currentStreamingSessionId===void 0;if(this.preloadedStreamingSessionId&&this.#a){const t=o.getMediaProductTransition(this.preloadedStreamingSessionId);t&&(this.#a.mediaProduct=t.mediaProduct),await this.load(this.#a,"implicit"),await this.updateOutputDevice(),e&&(this.playbackState="PLAYING"),this.playbackState==="IDLE"&&(this.playbackState="NOT_PLAYING");return}console.warn("No preloaded item in native player.")}async unloadPreloadedMediaProduct(){this.debugLog("unloadPreloadedMediaProduct",this.preloadedStreamingSessionId),this.hasNextItem()&&(this.cleanUpStoredPreloadInfo(),"cancelPreload"in this.#e?this.#e.cancelPreload():console.warn("cancelPreload not available. Update native player."))}updateDeviceMode(){this.updateOutputDevice()?.catch(console.error),a&&s.dispatchEvent(S(a.deviceMode))}updateOutputDevice(){if(!a||(this.debugLog("updateOutputDevice",a.activeDevice),!a.activeDevice))return Promise.resolve();const{nativeDeviceId:e}=a.activeDevice;if(this.outputDeviceType=a.activeDevice.type,e==="default")this.#s!=="default"&&(this.#e.selectSystemDevice(),s.dispatchEvent(P("default")),this.#s="default");else if(e){const t=a.getNativeDevice(e);t&&(this.#e.selectDevice(t,a.deviceMode),s.dispatchEvent(P(a.activeDevice.id)),s.dispatchEvent(S(a.deviceMode)),this.#s=e)}else throw new Error(`Device with sinkId ${e} not found.`);return Promise.resolve()}get ready(){return Promise.resolve()}get volume(){return v("desiredVolumeLevel")}set volume(e){this.debugLog("Setting volume to",e),this.#e.setVolume(e*100)}}export{_ as default};
