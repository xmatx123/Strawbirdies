import{x as I,R as g,w as p}from"./basePlayer-BtsXcGTi-SZiu-wWL.js";import{T as y,b as P,r as c,l as S,y as E,x as L}from"./index-BN722jHt-dG3f1Axa.js";class f extends I{#t;#r;#i=!0;#d;#e;#a=document.createElement("video");#s=!1;name="browserPlayer";constructor(){super(),this.playbackState="IDLE";const e=()=>{this.mediaElement&&!this.mediaElement.paused&&(this.playbackState="PLAYING")},i=a=>{this.currentStreamingSessionId&&a.target instanceof HTMLMediaElement&&c.overwriteDuration(this.currentStreamingSessionId,a.target.duration)},t=()=>{this.playbackState="STALLED"},s=()=>{(async()=>{const a=this.#t;if(a){if(this.preloadedStreamingSessionId&&a.currentTime===a.duration&&(await L(1e3),a.currentTime!==a.duration))return;this.playbackState="NOT_PLAYING"}})().catch(console.error)},n=a=>{if(a instanceof Event){const l=a.target;l.readyState>HTMLMediaElement.HAVE_NOTHING&&(this.currentTime=l.currentTime)}},d=a=>{n(a),this.finishCurrentMediaProduct("completed")},r=a=>console.error("HTMLMediaElement errored",a),o=()=>{this.mediaElement&&(this.currentTime=this.mediaElement.currentTime,this.seekEnd(this.currentTime))};this.#e={durationChangeHandler:i,endedHandler:d,errorHandler:r,pauseHandler:s,playHandler:e,playingHandler:e,seekedHandler:o,stalledHandler:t,timeUpdateHandler:n,waitingHandler:t},y().then().catch(console.error),this.#r=P,this.currentPlayer=this.#r}#n(e,i){this.debugLog("mediaElementEvents",i?"adding to":"removing from",e);const t=i?"addEventListener":"removeEventListener";e[t]("durationchange",this.#e.durationChangeHandler,{passive:!0}),e[t]("play",this.#e.playHandler,{passive:!0}),e[t]("playing",this.#e.playingHandler,{passive:!0}),e[t]("timeupdate",this.#e.timeUpdateHandler,{passive:!0}),e[t]("pause",this.#e.pauseHandler,{passive:!0}),e[t]("ended",this.#e.endedHandler,{passive:!0}),e[t]("error",this.#e.errorHandler,{passive:!0}),e[t]("waiting",this.#e.waitingHandler,{passive:!0}),e[t]("stalled",this.#e.stalledHandler,{passive:!0}),e[t]("seeked",this.#e.seekedHandler,{passive:!0})}getPosition(){return this.debugLog("getPosition"),this.mediaElement&&(this.mediaElement.ended?this.currentTime=0:this.currentTime=this.mediaElement.currentTime),this.currentTime}async load(e,i){this.debugLog("load",e),this.currentTime=e.assetPosition,this.startAssetPosition=e.assetPosition,await y(),await this.reset(),this.#i=!1,i==="explicit"&&(this.playbackState="NOT_PLAYING");const{assetPosition:t,mediaProduct:s,playbackInfo:n,streamInfo:d}=e;this.currentStreamingSessionId=d.streamingSessionId;const{currentPlayer:r}=this;if(!r)return;const o=new Promise(u=>r.addEventListener("canplay",()=>u(),{once:!0}));r.src=d.streamUrl,r.currentTime=t,r.load();const a=new Promise(u=>r.addEventListener("durationchange",m=>{m.target instanceof HTMLMediaElement&&u(m.target.duration)},{once:!0}));if(await o,this.currentStreamingSessionId!==d.streamingSessionId)return;const l=await a,h=g({assetPosition:t,duration:l,playbackInfo:n,streamInfo:d});return c.saveMediaProductTransition(d.streamingSessionId,{mediaProduct:s,playbackContext:h}),this.debugLog("dispatching mediaProductTransition"),S.dispatchEvent(p(s,h)),this.#s?(this.#s=!1,this.play()):Promise.resolve()}async next(e){this.debugLog("next",e),this.playbackState==="IDLE"&&(this.playbackState="NOT_PLAYING");const{mediaProduct:i,playbackInfo:t,streamInfo:s}=e,n=this.#a;if(this.preloadedStreamingSessionId=s.streamingSessionId,!n)return;n.src=s.streamUrl,n.load();const d=await new Promise(o=>n.addEventListener("durationchange",a=>{a.target instanceof HTMLMediaElement&&o(a.target.duration)},{once:!0})),r=g({assetPosition:0,duration:d,playbackInfo:t,streamInfo:s});c.saveMediaProductTransition(s.streamingSessionId,{mediaProduct:i,playbackContext:r}),this.#i=!1}pause(){this.debugLog("pause"),this.mediaElement&&this.mediaElement.pause()}async play(){if(this.debugLog("play"),await this.maybeHardReload(),this.playbackState==="IDLE")return this.debugLog("is IDLE, returning early"),this.#s=!0,Promise.resolve();"setSinkId"in P&&await this.updateOutputDevice(),this.currentStreamingSessionId&&this.mediaProductStarted(this.currentStreamingSessionId),this.setStateToXIfNotYInZMs(1e3,"PLAYING","STALLED"),this.currentPlayer&&await this.currentPlayer.play().catch(console.error)}async playbackEngineEndedHandler(e){if(this.isActivePlayer){const{reason:i}=e.detail;i==="completed"&&(this.hasNextItem()?(await this.skipToPreloadedMediaProduct(),await this.play()):(console.warn("No item preloaded, not progressing."),this.playbackState="NOT_PLAYING"))}}async reset({keepPreload:e}={keepPreload:!1}){if(this.#i)return Promise.resolve();this.debugLog("reset"),this.playbackState!=="IDLE"&&this.finishCurrentMediaProduct("skip"),this.playbackState="IDLE",this.detachPlaybackEngineEndedHandler(),this.currentStreamingSessionId=void 0,e||(this.preloadedStreamingSessionId=void 0);const{currentPlayer:i}=this;return i&&i.readyState!==0&&(i.load(),await new Promise(t=>i.addEventListener("emptied",()=>t(),{passive:!0}))),this.#i=!0,Promise.resolve()}seek(e){this.debugLog("seek",e);const{currentPlayer:i}=this,t=e;if(i)return this.seekStart(this.currentTime),"fastSeek"in i?i.fastSeek(t):i.currentTime=t,new Promise(s=>{i.addEventListener("seeked",()=>s(i.currentTime),{once:!0})})}async skipToPreloadedMediaProduct(){const e=c.getMediaProductTransition(this.preloadedStreamingSessionId);if(!e){this.playbackState="NOT_PLAYING";return}if(this.debugLog("skipToPreloadedMediaProduct",this.preloadedStreamingSessionId),this.#a.src&&this.currentPlayer){this.currentPlayer.src=this.#a.src,this.currentStreamingSessionId=String(this.preloadedStreamingSessionId),this.preloadedStreamingSessionId=void 0;const{mediaProduct:i,playbackContext:t}=e;S.dispatchEvent(p(i,t)),this.playbackState==="IDLE"&&(this.playbackState="NOT_PLAYING")}}togglePlayback(){this.debugLog("togglePlayback"),this.mediaElement&&(this.mediaElement.paused?this.mediaElement.play().catch(console.error):this.mediaElement.pause())}async unloadPreloadedMediaProduct(){this.debugLog("unloadPreloadedMediaProduct",this.preloadedStreamingSessionId),this.cleanUpStoredPreloadInfo();const e=this.#a;e&&(e.src="",e.load())}get currentPlayer(){return this.#t}set currentPlayer(e){this.debugLog("set currentPlayer",e),this.#t&&(this.#n(this.#t,!1),this.#t.load()),e&&(this.#t=e,this.#n(e,!0))}get mediaElement(){return this.currentPlayer??null}get ready(){return this.#d}get volume(){return E("desiredVolumeLevel")}set volume(e){this.debugLog("Setting volume to",e),this.currentPlayer&&(this.currentPlayer.volume=e)}}export{f as default};
